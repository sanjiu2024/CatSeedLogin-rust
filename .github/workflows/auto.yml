name: Build CatSeedLogin Plugin

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 0.0.1)'
        required: true
        default: '0.0.1'
      changelog:
        description: 'æ›´æ–°å†…å®¹ (ä¿®å¤çš„bugå’Œæ–°å¢žåŠŸèƒ½)'
        required: true
        default: 'ä¿®å¤å·²çŸ¥é—®é¢˜ï¼Œä¼˜åŒ–æ€§èƒ½'
  schedule:
    # æ¯12å°æ—¶è‡ªåŠ¨æž„å»ºä¸€æ¬¡ (UTCæ—¶é—´)
    - cron: '0 */12 * * *'

env:
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  RUSTFLAGS: "-A warnings"

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows
            file_extension: dll
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux
            file_extension: so
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: macos
            file_extension: dylib
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Determine version
      id: version
      shell: bash
      run: |
        # æ ¹æ®è§¦å‘æ–¹å¼ç¡®å®šç‰ˆæœ¬å·
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          # æ‰‹åŠ¨è§¦å‘ï¼šä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ç‰ˆæœ¬å·
          VERSION="${{ github.event.inputs.version }}"
          echo "æ‰‹åŠ¨è§¦å‘ç‰ˆæœ¬: $VERSION"
        elif [[ "${{ github.event_name }}" == "schedule" ]]; then
          # å®šæ—¶è§¦å‘ï¼šä½¿ç”¨æ—¥æœŸæ—¶é—´ä½œä¸ºç‰ˆæœ¬å·
          DATE=$(date +%Y%m%d)
          HOUR=$(date +%H)
          # å°†24å°æ—¶åˆ¶è½¬æ¢ä¸º12å°æ—¶åˆ¶æ®µ
          if [ $HOUR -lt 12 ]; then
            PERIOD="00-12"
          else
            PERIOD="12-24"
          fi
          VERSION="0.0.1-auto-$DATE-$PERIOD"
          echo "å®šæ—¶æž„å»ºç‰ˆæœ¬: $VERSION"
        else
          # æŽ¨é€è§¦å‘ï¼šä½¿ç”¨æäº¤SHAå‰7ä½
          VERSION="0.0.1-${GITHUB_SHA:0:7}"
          echo "æŽ¨é€æž„å»ºç‰ˆæœ¬: $VERSION"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Determine changelog
      id: changelog
      shell: bash
      run: |
        # æ ¹æ®è§¦å‘æ–¹å¼ç¡®å®šæ›´æ–°æ—¥å¿—
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          CHANGELOG="${{ github.event.inputs.changelog }}"
        elif [[ "${{ github.event_name }}" == "schedule" ]]; then
          CHANGELOG="å®šæ—¶è‡ªåŠ¨æž„å»º - ä¿®å¤å·²çŸ¥é—®é¢˜ï¼Œä¼˜åŒ–æ€§èƒ½"
        else
          # èŽ·å–æœ€è¿‘3ä¸ªæäº¤ä¿¡æ¯
          COMMITS=$(git log --oneline -3 --pretty=format:"- %s")
          CHANGELOG="è‡ªåŠ¨æž„å»ºæ›´æ–°ï¼š$COMMITS"
        fi
        
        echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: ${{ matrix.target }}
        profile: minimal

    - name: Add Rust target
      run: rustup target add ${{ matrix.target }}

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Build release
      run: cargo build --release --target ${{ matrix.target }}

    - name: Find library file
      shell: bash
      run: |
        # æŸ¥æ‰¾æž„å»ºå‡ºçš„åº“æ–‡ä»¶
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          LIB_FILE=$(find target/${{ matrix.target }}/release -name "*.dll" -type f | head -1)
        elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          LIB_FILE=$(find target/${{ matrix.target }}/release -name "*.so" -type f | head -1)
        else
          LIB_FILE=$(find target/${{ matrix.target }}/release -name "*.dylib" -type f | head -1)
        fi
        
        if [ -z "$LIB_FILE" ]; then
          echo "âŒ æœªæ‰¾åˆ°åº“æ–‡ä»¶ï¼Œæ£€æŸ¥æ‰€æœ‰æ–‡ä»¶:"
          find target/${{ matrix.target }}/release -type f
          exit 1
        fi
        
        echo "âœ… æ‰¾åˆ°åº“æ–‡ä»¶: $LIB_FILE"
        
        # å‡†å¤‡æ–‡ä»¶å
        ARTIFACT_NAME="CatSeedLogin_v${{ steps.version.outputs.version }}_${{ matrix.platform }}.${{ matrix.file_extension }}"
        
        mkdir -p dist
        cp "$LIB_FILE" "dist/$ARTIFACT_NAME"
        echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_ENV

    - name: Upload to CI Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CatSeedLogin-v${{ steps.version.outputs.version }}-${{ matrix.platform }}
        path: dist/${{ env.artifact_name }}
        retention-days: 90
        if-no-files-found: error

  create-summary:
    name: Create Build Summary
    runs-on: ubuntu-latest
    needs: build
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: CatSeedLogin-*
        merge-multiple: true

    - name: Create summary
      shell: bash
      run: |
        VERSION="${{ needs.build.outputs.version }}"
        CHANGELOG="${{ needs.build.outputs.changelog }}"
        TRIGGER_TYPE="${{ github.event_name }}"
        
        echo "# ðŸ± CatSeedLogin v${VERSION} æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ ¹æ®è§¦å‘ç±»åž‹æ˜¾ç¤ºä¸åŒçš„æ ‡é¢˜
        if [[ "$TRIGGER_TYPE" == "schedule" ]]; then
          echo "## â° å®šæ—¶è‡ªåŠ¨æž„å»º" >> $GITHUB_STEP_SUMMARY
        elif [[ "$TRIGGER_TYPE" == "workflow_dispatch" ]]; then
          echo "## ðŸ‘¤ æ‰‹åŠ¨è§¦å‘æž„å»º" >> $GITHUB_STEP_SUMMARY
        else
          echo "## ðŸ”„ è‡ªåŠ¨æž„å»º" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“‹ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬**: v${VERSION}" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: $TRIGGER_TYPE" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤**: ${GITHUB_SHA:0:7}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ”§ æ›´æ–°å†…å®¹" >> $GITHUB_STEP_SUMMARY
        echo "$CHANGELOG" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ðŸ“¦ ä¸‹è½½é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
        echo "æž„ä»¶å·²ä¸Šä¼ è‡³ GitHub Actions Artifactsï¼Œå¯åœ¨å³ä¾§ã€ŒArtifactsã€åŒºåŸŸä¸‹è½½ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # åˆ—å‡ºæ‰€æœ‰æž„å»ºçš„æ–‡ä»¶
        echo "### å¯ç”¨å¹³å°:" >> $GITHUB_STEP_SUMMARY
        ARTIFACT_FILES=$(find ./artifacts -name "*.dll" -o -name "*.so" -o -name "*.dylib" 2>/dev/null || true)
        
        if [ -n "$ARTIFACT_FILES" ]; then
          echo "$ARTIFACT_FILES" | while read file; do
            filename=$(basename "$file")
            echo "- âœ… $filename" >> $GITHUB_STEP_SUMMARY
          done
        else
          echo "- âŒ æœªæ‰¾åˆ°ä»»ä½•æž„ä»¶æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸš€ ä½¿ç”¨è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
        echo "1. ä¸‹è½½å¯¹åº”å¹³å°çš„åº“æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "2. å°†æ–‡ä»¶æ”¾å…¥ Pumpkin æœåŠ¡å™¨çš„ plugins ç›®å½•" >> $GITHUB_STEP_SUMMARY
        echo "3. é‡å¯æœåŠ¡å™¨" >> $GITHUB_STEP_SUMMARY
        
        # å®šæ—¶æž„å»ºçš„ç‰¹æ®Šè¯´æ˜Ž
        if [[ "$TRIGGER_TYPE" == "schedule" ]]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âš ï¸ æ³¨æ„" >> $GITHUB_STEP_SUMMARY
          echo "æ­¤ä¸ºå®šæ—¶è‡ªåŠ¨æž„å»ºç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªå®Œå…¨æµ‹è¯•çš„åŠŸèƒ½ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "å»ºè®®åœ¨ç”Ÿäº§çŽ¯å¢ƒä½¿ç”¨æ‰‹åŠ¨è§¦å‘çš„ç¨³å®šç‰ˆæœ¬ã€‚" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload summary as artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-summary-v${{ needs.build.outputs.version }}
        path: $GITHUB_STEP_SUMMARY
        retention-days: 30
        if-no-files-found: warn