name: Build CatSeedLogin Plugin

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  RUSTFLAGS: "-A warnings"

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows
            file_extension: dll
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux
            file_extension: so
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: macos
            file_extension: dylib
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Get version from Cargo.toml
      id: version
      shell: bash
      run: |
        VERSION=$(grep -E '^version\s*=' Cargo.toml | head -1 | cut -d'"' -f2)
        echo "version=$VERSION" >> $GITHUB_ENV
        echo "Version: $VERSION"

    - name: Get commit message
      id: commit
      shell: bash
      run: |
        # 只获取提交标题，避免换行符问题
        COMMIT_MSG=$(git log -1 --pretty=%s)
        echo "commit_msg=$COMMIT_MSG" >> $GITHUB_ENV
        echo "Commit: $COMMIT_MSG"

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: ${{ matrix.target }}
        profile: minimal

    - name: Add Rust target
      run: rustup target add ${{ matrix.target }}

    - name: Build release
      run: cargo build --release --target ${{ matrix.target }}

    - name: Find and copy library
      shell: bash
      run: |
        # 简化文件查找逻辑
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          EXT="dll"
        elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          EXT="so"
        else
          EXT="dylib"
        fi
        
        LIB_FILE=$(find target/${{ matrix.target }}/release -name "*.$EXT" -type f | head -1)
        
        if [ -z "$LIB_FILE" ]; then
          echo "Error: No library file found"
          find target/${{ matrix.target }}/release -type f
          exit 1
        fi
        
        ARTIFACT_NAME="CatSeedLogin_v${{ env.version }}_${{ matrix.platform }}.$EXT"
        mkdir -p dist
        cp "$LIB_FILE" "dist/$ARTIFACT_NAME"
        echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_ENV

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: CatSeedLogin-v${{ env.version }}-${{ matrix.platform }}
        path: dist/${{ env.artifact_name }}
        retention-days: 90

  summary:
    name: Create Summary
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Create summary
      shell: bash
      run: |
        echo "# CatSeedLogin v${{ env.version }} Build Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Latest Commit**: ${{ env.commit_msg }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Available Downloads**: Check Artifacts section" >> $GITHUB_STEP_SUMMARY