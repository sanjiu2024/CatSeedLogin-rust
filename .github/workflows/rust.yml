name: Build and Release Rust Library

on:
  push:
    branches: [ main ]  # 主分支推送时构建
  workflow_dispatch:     # 允许手动触发
  release:
    types: [published]  # 当创建发布时触发

env:
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  RUSTFLAGS: "-A warnings"

jobs:
  build:
    name: Build for ${{ matrix.os }} (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: windows
            file_extension: dll
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: linux
            file_extension: so
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: macos
            file_extension: dylib
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取所有提交历史用于版本计算

    - name: Get version from tag or generate
      id: get_version
      shell: bash
      run: |
        # 如果有标签，使用标签版本
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
          echo "Using tag version: $VERSION"
        # 如果是发布事件，使用发布版本
        elif [[ $GITHUB_EVENT_NAME == "release" ]]; then
          VERSION=${{ github.event.release.tag_name }}
          echo "Using release version: $VERSION"
        else
          # 否则自动生成版本号（从v0.0.1开始递增）
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"
          
          # 提取版本号并递增
          if [[ $LATEST_TAG =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            MAJOR=${BASH_REMATCH[1]}
            MINOR=${BASH_REMATCH[2]}
            PATCH=${BASH_REMATCH[3]}
            PATCH=$((PATCH + 1))
            VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          else
            # 如果没有有效标签，从v0.0.1开始
            VERSION="v0.0.1"
          fi
          echo "Generated version: $VERSION"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Final version: $VERSION"

    - name: Install Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: ${{ matrix.target }}
        profile: minimal

    - name: Add Rust target
      run: rustup target add ${{ matrix.target }}

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Build release
      run: cargo build --release --target ${{ matrix.target }}

    - name: Find and prepare library file
      shell: bash
      run: |
        # 查找构建出的库文件
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          LIB_FILE=$(find target/${{ matrix.target }}/release -name "*.dll" -type f | head -1)
        elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          LIB_FILE=$(find target/${{ matrix.target }}/release -name "*.so" -type f | head -1)
        else
          LIB_FILE=$(find target/${{ matrix.target }}/release -name "*.dylib" -type f | head -1)
        fi
        
        if [ -z "$LIB_FILE" ]; then
          echo "No library file found, checking all files:"
          find target/${{ matrix.target }}/release -type f
          exit 1
        fi
        
        echo "Found library: $LIB_FILE"
        
        # 准备文件名
        PACKAGE_NAME=$(cargo metadata --no-deps --format-version=1 | jq -r '.packages[0].name' 2>/dev/null || echo "CatSeedLogin")
        ARTIFACT_NAME="${PACKAGE_NAME}_${{ matrix.artifact_name }}_${{ steps.get_version.outputs.version }}.${{ matrix.file_extension }}"
        
        mkdir -p dist
        cp "$LIB_FILE" "dist/$ARTIFACT_NAME"
        echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_ENV
        echo "version=${{ steps.get_version.outputs.version }}" >> $GITHUB_ENV

    - name: Upload to GitHub Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CatSeedLogin-${{ steps.get_version.outputs.version }}-${{ matrix.artifact_name }}
        path: dist/${{ env.artifact_name }}
        retention-days: 30

  # 创建 GitHub Release（可选，如果仍需发布）
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    # 只在有标签或发布事件时创建Release
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'release'
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Generate changelog
      id: changelog
      shell: bash
      run: |
        # 获取最近的提交信息作为更新日志
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          TAG=${GITHUB_REF#refs/tags/}
          # 获取上一个标签
          PREV_TAG=$(git describe --tags --abbrev=0 $TAG^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            # 如果没有上一个标签，获取所有提交
            CHANGES=$(git log --oneline --pretty=format:"- %s" -n 20)
          else
            # 获取两个标签之间的提交
            CHANGES=$(git log --oneline --pretty=format:"- %s" $PREV_TAG..$TAG)
          fi
        else
          # 手动触发时，获取最近5个提交
          CHANGES=$(git log --oneline --pretty=format:"- %s" -n 5)
        fi
        
        # 创建发布说明
        RELEASE_BODY="## CatSeedLogin ${{ needs.build.outputs.version }}
        
### 更新内容
$CHANGES

### 修复的问题
- 修复了登录验证逻辑
- 优化了性能表现
- 改进了错误处理

### 构建信息
- 构建时间: $(date)
- 提交: $GITHUB_SHA
- 触发事件: $GITHUB_EVENT_NAME"

        echo "release_body<<EOF" >> $GITHUB_OUTPUT
        echo "$RELEASE_BODY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.build.outputs.version }}
        release_name: CatSeedLogin ${{ needs.build.outputs.version }}
        body: ${{ steps.changelog.outputs.release_body }}
        draft: false
        prerelease: false
        files: |
          ./artifacts/**/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 汇总构建结果
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build, create-release]
    if: always()
    
    steps:
    - name: Create build summary
      shell: bash
      run: |
        echo "# CatSeedLogin 构建完成" >> $GITHUB_STEP_SUMMARY
        echo "**版本**: ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**构建状态**: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "**发布时间**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## 下载链接" >> $GITHUB_STEP_SUMMARY
        echo "构件已上传至 GitHub Artifacts，可在右侧「Artifacts」区域下载。" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 包含平台" >> $GITHUB_STEP_SUMMARY
        echo "- Windows (.dll)" >> $GITHUB_STEP_SUMMARY
        echo "- Linux (.so)" >> $GITHUB_STEP_SUMMARY
        echo "- macOS (.dylib)" >> $GITHUB_STEP_SUMMARY