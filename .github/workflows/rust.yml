name: Build CatSeedLogin Plugin

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发
    inputs:
      changelog:
        description: '更新内容 (修复的bug和新增功能)'
        required: true
        default: '修复已知问题，优化性能'

env:
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  RUSTFLAGS: "-A warnings"

jobs:
  get-version:
    name: Get Version from Cargo.toml
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Extract version from Cargo.toml
      id: get-version
      shell: bash
      run: |
        # 从Cargo.toml文件中提取版本号
        if [ -f "Cargo.toml" ]; then
          VERSION=$(grep -E '^version\s*=' Cargo.toml | head -1 | cut -d'"' -f2)
          echo "从Cargo.toml中提取的版本号: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        else
          echo "错误: 未找到Cargo.toml文件"
          exit 1
        fi

  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: get-version
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows
            file_extension: dll
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux
            file_extension: so
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: macos
            file_extension: dylib
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: ${{ matrix.target }}
        profile: minimal

    - name: Add Rust target
      run: rustup target add ${{ matrix.target }}

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Build release
      run: cargo build --release --target ${{ matrix.target }}

    - name: Find library file
      shell: bash
      run: |
        # 查找构建出的库文件
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          LIB_FILE=$(find target/${{ matrix.target }}/release -name "*.dll" -type f | head -1)
        elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          LIB_FILE=$(find target/${{ matrix.target }}/release -name "*.so" -type f | head -1)
        else
          LIB_FILE=$(find target/${{ matrix.target }}/release -name "*.dylib" -type f | head -1)
        fi
        
        if [ -z "$LIB_FILE" ]; then
          echo "❌ 未找到库文件，检查所有文件:"
          find target/${{ matrix.target }}/release -type f
          exit 1
        fi
        
        echo "✅ 找到库文件: $LIB_FILE"
        
        # 准备文件名
        VERSION="${{ needs.get-version.outputs.version }}"
        ARTIFACT_NAME="CatSeedLogin_v${VERSION}_${{ matrix.platform }}.${{ matrix.file_extension }}"
        
        mkdir -p dist
        cp "$LIB_FILE" "dist/$ARTIFACT_NAME"
        echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_ENV

    - name: Upload to CI Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CatSeedLogin-v${{ env.version }}-${{ matrix.platform }}
        path: dist/${{ env.artifact_name }}
        retention-days: 90

  create-summary:
    name: Create Build Summary
    runs-on: ubuntu-latest
    needs: [get-version, build]
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: CatSeedLogin-*
        merge-multiple: true

    - name: Create summary
      shell: bash
      run: |
        VERSION="${{ needs.get-version.outputs.version }}"
        CHANGELOG="${{ github.event.inputs.changelog || '修复已知问题，优化性能' }}"
        
        echo "# 🐱 CatSeedLogin v${VERSION} 构建完成" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## 📋 构建信息" >> $GITHUB_STEP_SUMMARY
        echo "- **版本**: v${VERSION}" >> $GITHUB_STEP_SUMMARY
        echo "- **构建时间**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **触发方式**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **提交**: ${GITHUB_SHA:0:7}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## 🔧 更新内容" >> $GITHUB_STEP_SUMMARY
        echo "$CHANGELOG" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## 📦 下载链接" >> $GITHUB_STEP_SUMMARY
        echo "构件已上传至 GitHub Actions Artifacts，可在右侧「Artifacts」区域下载：" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # 修复：完整的if语句，检查文件是否存在
        echo "### 可用平台:" >> $GITHUB_STEP_SUMMARY
        
        #检查Windows文件
        if [ -f "./artifacts/CatSeedLogin_v${VERSION}_windows.dll" ]; then
          echo "- ✅ Windows (x64) - CatSeedLogin_v${VERSION}_windows.dll" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ❌ Windows 构建失败" >> $GITHUB_STEP_SUMMARY
        fi
        
        # 检查Linux文件
        if [ -f "./artifacts/CatSeedLogin_v${VERSION}_linux.so" ]; then
          echo "- ✅ Linux (x64) - CatSeedLogin_v${VERSION}_linux.so" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ❌ Linux 构建失败" >> $GITHUB_STEP_SUMMARY
        fi
        
        # 检查macOS文件
        if [ -f "./artifacts/CatSeedLogin_v${VERSION}_macos.dylib" ]; then
          echo "- ✅ macOS (x64) - CatSeedLogin_v${VERSION}_macos.dylib" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ❌ macOS 构建失败" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## 🚀 使用说明" >> $GITHUB_STEP_SUMMARY
        echo "1. 下载对应平台的库文件" >> $GITHUB_STEP_SUMMARY
        echo "2. 将文件放入 Pumpkin 服务器的 plugins 目录" >> $GITHUB_STEP_SUMMARY
        echo "3. 重启服务器" >> $GITHUB_STEP_SUMMARY
        
        # 同时输出到日志
        echo "构建完成: CatSeedLogin v${VERSION}"
        echo "更新内容: ${CHANGELOG}"
